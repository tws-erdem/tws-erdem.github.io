<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Add a line to a map using a GeoJSON source</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

<script>
    const geojson = {
        'type': 'FeatureCollection',
        'features': [
            {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    "coordinates": [
                        [
                            -0.10419,
                            51.59851
                        ],
                        [
                            -0.10379,
                            51.59863
                        ],
                        [
                            -0.10301,
                            51.59886
                        ],
                        [
                            -0.10276,
                            51.59896
                        ],
                        [
                            -0.10276,
                            51.59896
                        ],
                        [
                            -0.10261,
                            51.59902
                        ],
                        [
                            -0.10237,
                            51.59908
                        ],
                        [
                            -0.10192,
                            51.59921
                        ],
                        [
                            -0.10156,
                            51.5993
                        ],
                        [
                            -0.10109,
                            51.59943
                        ],
                        [
                            -0.10086,
                            51.59949
                        ],
                        [
                            -0.10091,
                            51.59952
                        ],
                        [
                            -0.10093,
                            51.59955
                        ],
                        [
                            -0.10094,
                            51.59958
                        ],
                        [
                            -0.10095,
                            51.59962
                        ],
                        [
                            -0.10107,
                            51.59969
                        ],
                        [
                            -0.10115,
                            51.59974
                        ],
                        [
                            -0.10115,
                            51.59974
                        ],
                        [
                            -0.10119,
                            51.59978
                        ],
                        [
                            -0.10232,
                            51.60069
                        ],
                        [
                            -0.10293,
                            51.60118
                        ],
                        [
                            -0.10336,
                            51.6015
                        ],
                        [
                            -0.1041,
                            51.60209
                        ],
                        [
                            -0.10421,
                            51.60218
                        ],
                        [
                            -0.10421,
                            51.60218
                        ],
                        [
                            -0.10452,
                            51.60243
                        ],
                        [
                            -0.10426,
                            51.60275
                        ],
                        [
                            -0.10419,
                            51.60283
                        ],
                        [
                            -0.10416,
                            51.60301
                        ],
                        [
                            -0.10403,
                            51.60354
                        ],
                        [
                            -0.10391,
                            51.60402
                        ],
                        [
                            -0.1038,
                            51.6045
                        ],
                        [
                            -0.10382,
                            51.60484
                        ],
                        [
                            -0.10382,
                            51.60484
                        ],
                        [
                            -0.10382,
                            51.60498
                        ],
                        [
                            -0.10375,
                            51.60541
                        ],
                        [
                            -0.10368,
                            51.60569
                        ],
                        [
                            -0.10369,
                            51.60608
                        ],
                        [
                            -0.10414,
                            51.60607
                        ],
                        [
                            -0.10414,
                            51.60607
                        ],
                        [
                            -0.10534,
                            51.60604
                        ],
                        [
                            -0.10934,
                            51.60596
                        ],
                        [
                            -0.10986,
                            51.60595
                        ],
                        [
                            -0.11073,
                            51.60593
                        ],
                        [
                            -0.11093,
                            51.60592
                        ],
                        [
                            -0.11152,
                            51.60591
                        ],
                        [
                            -0.11143,
                            51.60613
                        ],
                        [
                            -0.11137,
                            51.60626
                        ],
                        [
                            -0.11129,
                            51.60642
                        ],
                        [
                            -0.11129,
                            51.60642
                        ],
                        [
                            -0.11122,
                            51.60658
                        ],
                        [
                            -0.11112,
                            51.6068
                        ],
                        [
                            -0.11089,
                            51.60725
                        ],
                        [
                            -0.11085,
                            51.60733
                        ],
                        [
                            -0.11083,
                            51.6074
                        ],
                        [
                            -0.1108,
                            51.60746
                        ],
                        [
                            -0.1106,
                            51.6079
                        ],
                        [
                            -0.11048,
                            51.60819
                        ],
                        [
                            -0.11046,
                            51.60822
                        ],
                        [
                            -0.1104,
                            51.60837
                        ],
                        [
                            -0.1103,
                            51.60861
                        ],
                        [
                            -0.11022,
                            51.60885
                        ],
                        [
                            -0.10999,
                            51.60954
                        ],
                        [
                            -0.10995,
                            51.60967
                        ],
                        [
                            -0.10986,
                            51.60999
                        ],
                        [
                            -0.1098,
                            51.61023
                        ],
                        [
                            -0.10973,
                            51.61046
                        ],
                        [
                            -0.10961,
                            51.61088
                        ],
                        [
                            -0.10959,
                            51.61111
                        ],
                        [
                            -0.10953,
                            51.61134
                        ],
                        [
                            -0.10951,
                            51.61158
                        ],
                        [
                            -0.10951,
                            51.61165
                        ],
                        [
                            -0.10952,
                            51.61169
                        ],
                        [
                            -0.10952,
                            51.61175
                        ],
                        [
                            -0.10958,
                            51.61179
                        ],
                        [
                            -0.1096,
                            51.61201
                        ],
                        [
                            -0.10964,
                            51.61228
                        ],
                        [
                            -0.10965,
                            51.61235
                        ],
                        [
                            -0.10966,
                            51.61245
                        ],
                        [
                            -0.10949,
                            51.61243
                        ],
                        [
                            -0.10921,
                            51.6124
                        ],
                        [
                            -0.10912,
                            51.6124
                        ],
                        [
                            -0.109,
                            51.61239
                        ],
                        [
                            -0.10875,
                            51.6124
                        ],
                        [
                            -0.10875,
                            51.6124
                        ],
                        [
                            -0.10859,
                            51.6124
                        ],
                        [
                            -0.10829,
                            51.61242
                        ],
                        [
                            -0.10791,
                            51.61248
                        ],
                        [
                            -0.10768,
                            51.61253
                        ],
                        [
                            -0.1075,
                            51.61258
                        ],
                        [
                            -0.10629,
                            51.61298
                        ],
                        [
                            -0.10611,
                            51.61304
                        ],
                        [
                            -0.10596,
                            51.61309
                        ],
                        [
                            -0.10578,
                            51.61315
                        ],
                        [
                            -0.10455,
                            51.61358
                        ],
                        [
                            -0.104,
                            51.61377
                        ],
                        [
                            -0.10393,
                            51.61379
                        ],
                        [
                            -0.10279,
                            51.61419
                        ],
                        [
                            -0.10234,
                            51.61434
                        ],
                        [
                            -0.10189,
                            51.6145
                        ],
                        [
                            -0.10137,
                            51.61467
                        ],
                        [
                            -0.10129,
                            51.6147
                        ],
                        [
                            -0.10114,
                            51.61475
                        ],
                        [
                            -0.10049,
                            51.61496
                        ],
                        [
                            -0.10032,
                            51.61501
                        ],
                        [
                            -0.09998,
                            51.61512
                        ],
                        [
                            -0.09911,
                            51.61539
                        ],
                        [
                            -0.09893,
                            51.61544
                        ],
                        [
                            -0.09838,
                            51.6156
                        ],
                        [
                            -0.09765,
                            51.61579
                        ],
                        [
                            -0.09745,
                            51.61584
                        ],
                        [
                            -0.09726,
                            51.61588
                        ],
                        [
                            -0.09709,
                            51.61592
                        ],
                        [
                            -0.09658,
                            51.61601
                        ],
                        [
                            -0.0957,
                            51.61613
                        ],
                        [
                            -0.09531,
                            51.61616
                        ],
                        [
                            -0.09386,
                            51.61625
                        ],
                        [
                            -0.0926,
                            51.6163
                        ],
                        [
                            -0.09145,
                            51.61635
                        ],
                        [
                            -0.09102,
                            51.61637
                        ],
                        [
                            -0.0908,
                            51.61642
                        ],
                        [
                            -0.09049,
                            51.61646
                        ],
                        [
                            -0.08988,
                            51.6165
                        ],
                        [
                            -0.08956,
                            51.61651
                        ],
                        [
                            -0.08841,
                            51.61651
                        ],
                        [
                            -0.08841,
                            51.61651
                        ],
                        [
                            -0.08816,
                            51.61651
                        ],
                        [
                            -0.08789,
                            51.61651
                        ],
                        [
                            -0.08759,
                            51.61651
                        ],
                        [
                            -0.08716,
                            51.61655
                        ],
                        [
                            -0.087,
                            51.61664
                        ],
                        [
                            -0.08688,
                            51.61667
                        ],
                        [
                            -0.08671,
                            51.61671
                        ],
                        [
                            -0.08654,
                            51.61671
                        ],
                        [
                            -0.08642,
                            51.61669
                        ],
                        [
                            -0.08639,
                            51.61668
                        ],
                        [
                            -0.08632,
                            51.61665
                        ],
                        [
                            -0.08625,
                            51.61661
                        ],
                        [
                            -0.08616,
                            51.61656
                        ],
                        [
                            -0.08611,
                            51.6165
                        ],
                        [
                            -0.08606,
                            51.61642
                        ],
                        [
                            -0.08606,
                            51.61636
                        ],
                        [
                            -0.08606,
                            51.6163
                        ],
                        [
                            -0.08609,
                            51.61625
                        ],
                        [
                            -0.08616,
                            51.61616
                        ],
                        [
                            -0.08627,
                            51.61609
                        ],
                        [
                            -0.08635,
                            51.61605
                        ],
                        [
                            -0.08646,
                            51.61602
                        ],
                        [
                            -0.08662,
                            51.61592
                        ],
                        [
                            -0.08667,
                            51.61581
                        ],
                        [
                            -0.08671,
                            51.61573
                        ],
                        [
                            -0.08676,
                            51.6149
                        ],
                        [
                            -0.08679,
                            51.61451
                        ],
                        [
                            -0.08678,
                            51.6143
                        ],
                        [
                            -0.08675,
                            51.61388
                        ],
                        [
                            -0.08674,
                            51.61377
                        ],
                        [
                            -0.0867,
                            51.61347
                        ],
                        [
                            -0.08666,
                            51.61314
                        ],
                        [
                            -0.0866,
                            51.61283
                        ],
                        [
                            -0.08651,
                            51.61259
                        ],
                        [
                            -0.08651,
                            51.61259
                        ],
                        [
                            -0.08642,
                            51.61234
                        ],
                        [
                            -0.08615,
                            51.61159
                        ],
                        [
                            -0.08598,
                            51.61112
                        ],
                        [
                            -0.08578,
                            51.61057
                        ],
                        [
                            -0.08555,
                            51.60957
                        ],
                        [
                            -0.08554,
                            51.60934
                        ],
                        [
                            -0.08552,
                            51.60897
                        ],
                        [
                            -0.08552,
                            51.60853
                        ],
                        [
                            -0.08553,
                            51.6084
                        ],
                        [
                            -0.08553,
                            51.60831
                        ],
                        [
                            -0.08555,
                            51.60803
                        ],
                        [
                            -0.08559,
                            51.60736
                        ],
                        [
                            -0.08561,
                            51.60708
                        ],
                        [
                            -0.08561,
                            51.60703
                        ],
                        [
                            -0.08562,
                            51.60691
                        ],
                        [
                            -0.08563,
                            51.6067
                        ],
                        [
                            -0.08566,
                            51.60626
                        ],
                        [
                            -0.08568,
                            51.60605
                        ],
                        [
                            -0.0857,
                            51.60588
                        ],
                        [
                            -0.08572,
                            51.60578
                        ],
                        [
                            -0.08576,
                            51.60576
                        ],
                        [
                            -0.08577,
                            51.60575
                        ],
                        [
                            -0.08582,
                            51.60558
                        ],
                        [
                            -0.08583,
                            51.60555
                        ],
                        [
                            -0.08585,
                            51.60553
                        ],
                        [
                            -0.08587,
                            51.60552
                        ],
                        [
                            -0.08589,
                            51.60551
                        ],
                        [
                            -0.08593,
                            51.6055
                        ],
                        [
                            -0.08598,
                            51.6055
                        ],
                        [
                            -0.0863,
                            51.60558
                        ],
                        [
                            -0.0863,
                            51.60558
                        ],
                        [
                            -0.08658,
                            51.60566
                        ],
                        [
                            -0.08789,
                            51.606
                        ],
                        [
                            -0.08791,
                            51.606
                        ],
                        [
                            -0.08848,
                            51.60615
                        ],
                        [
                            -0.09066,
                            51.60671
                        ],
                        [
                            -0.09092,
                            51.60675
                        ],
                        [
                            -0.09111,
                            51.60674
                        ],
                        [
                            -0.09142,
                            51.60671
                        ],
                        [
                            -0.09208,
                            51.60668
                        ],
                        [
                            -0.09213,
                            51.60667
                        ],
                        [
                            -0.09258,
                            51.60657
                        ],
                        [
                            -0.09303,
                            51.60639
                        ],
                        [
                            -0.09353,
                            51.60618
                        ],
                        [
                            -0.0943,
                            51.60572
                        ],
                        [
                            -0.09446,
                            51.60562
                        ],
                        [
                            -0.09478,
                            51.60544
                        ],
                        [
                            -0.09507,
                            51.60526
                        ],
                        [
                            -0.09511,
                            51.60513
                        ],
                        [
                            -0.09512,
                            51.60505
                        ],
                        [
                            -0.09512,
                            51.60505
                        ],
                        [
                            -0.09512,
                            51.60503
                        ],
                        [
                            -0.09511,
                            51.60496
                        ],
                        [
                            -0.09508,
                            51.60492
                        ],
                        [
                            -0.09503,
                            51.60484
                        ],
                        [
                            -0.09481,
                            51.60473
                        ],
                        [
                            -0.09407,
                            51.60434
                        ],
                        [
                            -0.0942,
                            51.60423
                        ],
                        [
                            -0.0942,
                            51.60423
                        ],
                        [
                            -0.0943,
                            51.60415
                        ],
                        [
                            -0.0944,
                            51.604
                        ],
                        [
                            -0.09448,
                            51.60385
                        ],
                        [
                            -0.09449,
                            51.60374
                        ],
                        [
                            -0.09465,
                            51.60374
                        ],
                        [
                            -0.09474,
                            51.60374
                        ],
                        [
                            -0.0951,
                            51.60373
                        ],
                        [
                            -0.09529,
                            51.60372
                        ],
                        [
                            -0.09548,
                            51.60372
                        ],
                        [
                            -0.09576,
                            51.60372
                        ],
                        [
                            -0.09576,
                            51.60372
                        ],
                        [
                            -0.09676,
                            51.6037
                        ],
                        [
                            -0.09672,
                            51.60274
                        ],
                        [
                            -0.09676,
                            51.60267
                        ],
                        [
                            -0.09724,
                            51.60233
                        ],
                        [
                            -0.09724,
                            51.60233
                        ],
                        [
                            -0.09786,
                            51.60189
                        ],
                        [
                            -0.09753,
                            51.60172
                        ],
                        [
                            -0.09631,
                            51.60157
                        ],
                        [
                            -0.09631,
                            51.60157
                        ],
                        [
                            -0.09617,
                            51.60156
                        ],
                        [
                            -0.09619,
                            51.60144
                        ],
                        [
                            -0.09633,
                            51.60098
                        ],
                        [
                            -0.09637,
                            51.60081
                        ],
                        [
                            -0.09619,
                            51.60079
                        ],
                        [
                            -0.09619,
                            51.60079
                        ],
                        [
                            -0.09591,
                            51.60076
                        ],
                        [
                            -0.09498,
                            51.6009
                        ],
                        [
                            -0.09391,
                            51.60103
                        ],
                        [
                            -0.09391,
                            51.60103
                        ],
                        [
                            -0.09343,
                            51.60109
                        ],
                        [
                            -0.09362,
                            51.60166
                        ],
                        [
                            -0.09377,
                            51.60207
                        ],
                        [
                            -0.09377,
                            51.60207
                        ],
                        [
                            -0.09379,
                            51.60212
                        ],
                        [
                            -0.09394,
                            51.60221
                        ],
                        [
                            -0.09521,
                            51.60227
                        ],
                        [
                            -0.09587,
                            51.60248
                        ],
                        [
                            -0.09592,
                            51.60231
                        ],
                        [
                            -0.09592,
                            51.60231
                        ],
                        [
                            -0.09617,
                            51.60156
                        ],
                        [
                            -0.09619,
                            51.60144
                        ],
                        [
                            -0.09633,
                            51.60098
                        ],
                        [
                            -0.09637,
                            51.60081
                        ],
                        [
                            -0.09652,
                            51.60041
                        ],
                        [
                            -0.09667,
                            51.60003
                        ],
                        [
                            -0.09683,
                            51.59963
                        ],
                        [
                            -0.09714,
                            51.59967
                        ],
                        [
                            -0.09714,
                            51.59967
                        ],
                        [
                            -0.09751,
                            51.59972
                        ],
                        [
                            -0.09806,
                            51.59975
                        ],
                        [
                            -0.09821,
                            51.59975
                        ],
                        [
                            -0.09915,
                            51.59971
                        ],
                        [
                            -0.09942,
                            51.59965
                        ],
                        [
                            -0.09953,
                            51.59955
                        ],
                        [
                            -0.09971,
                            51.59959
                        ],
                        [
                            -0.10002,
                            51.5996
                        ],
                        [
                            -0.10046,
                            51.59954
                        ],
                        [
                            -0.10046,
                            51.59954
                        ],
                        [
                            -0.10072,
                            51.59951
                        ],
                        [
                            -0.10086,
                            51.59949
                        ],
                        [
                            -0.10109,
                            51.59943
                        ],
                        [
                            -0.10156,
                            51.5993
                        ],
                        [
                            -0.10192,
                            51.59921
                        ],
                        [
                            -0.10237,
                            51.59908
                        ],
                        [
                            -0.10253,
                            51.59904
                        ],
                        [
                            -0.10253,
                            51.59904
                        ],
                        [
                            -0.10261,
                            51.59902
                        ],
                        [
                            -0.10301,
                            51.59886
                        ],
                        [
                            -0.10379,
                            51.59863
                        ],
                        [
                            -0.10435,
                            51.59846
                        ],
                        [
                            -0.10447,
                            51.59843
                        ]
                    ]
                }
            }
        ]
    };
    mapboxgl.accessToken = 'pk.eyJ1IjoiZXJkZW1vemtvbCIsImEiOiJjbHNmMGhqdjIwYmtoMmxvdWpqOXI0eHpxIn0.vigeREpMRCnKk5T_7YjW6Q';
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: 'mapbox://styles/mapbox/standard', // style URL
        center: [-0.10419, 51.60672],
        zoom: 14, // starting zoom
        pitch: 45,
        bearing: -17.6,
        antialias: true

    });

    map.on('load', () => {
        map.addSource('route', {
            type: 'geojson',
            data: geojson
        });

        map.addLayer({
            id: 'route-line',
            type: 'line',
            source: 'route',
            layout: {
                'line-join': 'round',
                'line-cap': 'round'
            },
            paint: {
                'line-color': '#c20600',
                'line-width': 5
            }
        });
        map.loadImage("/wiki_reader/skecth/mapbox_js/car-3d.png", function (error, image){
            if (error) throw error;
            map.addImage('car', image);
        });
        // Add car symbol layer
        map.addLayer({
            id: 'car-symbol',
            type: 'symbol',
            source: {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            },
            layout: {
                'icon-image': 'car', // use 'car' or other built-in icon of mapbox, or you can upload your own
                'icon-rotate': ['get', 'bearing'],
                'icon-rotation-alignment': 'map',
                'icon-allow-overlap': true,
                'icon-ignore-placement': true,
                'icon-size': 0.1  // Adjust the size as needed (1 is the default size)
            },
            paint: {
                'icon-color': '#f00', // Set red color
            }
        });

        // Function to calculate position along route
        function calculatePosition(route, distance) {
            const routeLine = route.features[0].geometry.coordinates;

            // Handle potential errors and edge cases
            if (!routeLine || routeLine.length === 0) {
                return null; // Handle empty or invalid route data
            }

            // Calculate total route length using Turf.js Point objects
            const totalRouteLength = turf.length(turf.lineString(routeLine));

            // Ensure distance doesn't exceed route length
            distance = Math.min(distance, totalRouteLength);

            let traveledDistance = 0;
            let currentSegmentIndex = 0;

            while (traveledDistance < distance && currentSegmentIndex < routeLine.length - 1) {
                const nextPoint = routeLine[currentSegmentIndex + 1];

                // Create Turf.js Point objects for distance calculations
                const currentPoint = turf.point(routeLine[currentSegmentIndex]);
                const nextPointObj = turf.point(nextPoint);

                // Check segment end or route end
                if (!nextPoint || traveledDistance + turf.distance(currentPoint, nextPointObj) >= distance) {
                    const fraction = (distance - traveledDistance) / turf.distance(currentPoint, nextPointObj);
                    const segmentLineString = turf.lineString([routeLine[currentSegmentIndex], nextPoint]);
                    const interpolatedPoint = turf.along(line = segmentLineString, distance = fraction);
                    return interpolatedPoint.geometry.coordinates;
                } else {
                    traveledDistance += turf.distance(currentPoint, nextPointObj);
                    currentSegmentIndex++;
                }
            }

            // Return point on the last segment
            return turf.point(routeLine[currentSegmentIndex]).geometry.coordinates;
        }


        // Animation setup
        let distanceTraveled = 0;
        let totalRouteLength; // Store total route length

        function animateCar(timestamp) {
            const rr = map.getSource('route')._data
            const rl = rr.features[0].geometry.coordinates
            // Calculate total route length once if not already done
            if (!totalRouteLength) {
                totalRouteLength = turf.length(turf.lineString(rl));
            }

            // Control animation speed and handle route length
            distanceTraveled = Math.min(distanceTraveled + totalRouteLength / 30000, totalRouteLength);
            const carPosition = calculatePosition(map.getSource('route')._data, distanceTraveled);
            map.getSource('car-symbol').setData({
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: carPosition
                        }
                    }
                ]
            });

            // Rotate car icon based on route direction (optional)
            // ...
            if (distanceTraveled >= totalRouteLength) {
                return
            }
            requestAnimationFrame(animateCar);
        }

        map.getSource('route').setData(geojson);
        animateCar(1000);
    });
</script>

</body>
</html>